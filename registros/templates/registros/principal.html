{% extends "inicio/encabezado.html" %}

{% block titulo %} Principal {% endblock %}
{% load static %}

{% block contenido %}
<div class="page-content">
    <h1>Bienvenidos padres de familia - Tareas</h1>
    <div>
        <img src="#" alt="">
    </div>

    <!-- Filtro -->
    <form method="get" class="mb-3 d-flex gap-2 align-items-end" style="gap: .5rem; flex-wrap: wrap;">
  <div>
    <label for="estado" class="form-label">Estado</label>
    <select name="estado" id="estado" class="form-control" onchange="this.form.submit()">
      <option value="todas" {% if filtro_estado == "todas" %}selected{% endif %}>Todas</option>
      <option value="pendiente" {% if filtro_estado == "pendiente" %}selected{% endif %}>Pendientes</option>
      <option value="terminada" {% if filtro_estado == "terminada" %}selected{% endif %}>Terminadas</option>
    </select>
  </div>

  <div>
    <label for="alumno" class="form-label">Alumno</label>
    <select name="alumno" id="alumno" class="form-control" onchange="this.form.submit()">
      <option value="">Todos</option>
      {% for a in alumnos_list %}
        <option value="{{ a.id }}" {% if alumno_seleccionado|stringformat:'s' == a.id|stringformat:'s' %}selected{% endif %}>
          {{ a.nombre }} ({{ a.ident }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label for="q" class="form-label">Buscar (nombre/ID)</label>
    <input type="text" name="q" id="q" class="form-control" value="{{ q }}" placeholder="Ej. Juan o 12345">
  </div>

  <div>
    <button type="submit" class="btn btn-primary">Aplicar</button>
    <a href="{% url 'tareas' %}" class="btn btn-secondary">Limpiar</a>
  </div>
</form>

    <!-- Tabla -->
    <div>
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Foto</th>
                    <th>Identificaci√≥n</th>
                    <th>Nombre del Alumno</th>
                    <th>Tarea</th>
                    <th>Acciones / Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for alumno_id, data in alumnos_con_tareas.items %}
                {% with alumno=data.alumno tareas=data.tareas %}
                <tr>
                    <!-- Info del alumno -->
                    <td class="text-center" rowspan="{{ tareas|length }}">
                        {% if alumno.foto %}
                            <img src="{{ alumno.foto.url }}" alt="{{ alumno.nombre }}" class="img-media" style="width: 50px; height: 50px; border-radius: 50%;">
                        {% else %}
                            <span class="text-muted">Sin foto</span>
                        {% endif %}
                    </td>
                    <td class="text-center" rowspan="{{ tareas|length }}">{{ alumno.ident }}</td>
                    <td class="muted" rowspan="{{ tareas|length }}">{{ alumno.nombre }}</td>

                    <!-- Info de tareas -->
                    {% for asignacion in tareas %}
                        {% if not forloop.first %}<tr>{% endif %}
                            <td>
                                <strong>{{ asignacion.tarea.nombre }}</strong><br>
                                <small class="text-muted">{{ asignacion.tarea.descripcion }}</small>
                            </td>
                            <td class="text-center">
                                {% if asignacion.estado == "pendiente" %}
                                    <a href="{% url 'entregar_tarea' asignacion.id %}" class="btn btn-sm btn-primary">Entregar</a>
                                {% else %}
                                    <span class="badge badge-success">Terminada</span><br>
                                    {% if asignacion.evidencia %}
                                        <a href="{{ asignacion.evidencia.url }}" target="_blank" class="btn btn-sm btn-info mt-1">Ver evidencia</a>
                                        <a href="{% url 'entregar_tarea' asignacion.id %}" class="btn btn-sm btn-warning mt-1">Reemplazar</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        {% if not forloop.first %}</tr>{% endif %}
                    {% endfor %}
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No hay tareas registradas</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
